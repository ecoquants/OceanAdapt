---
title: "Aleutian Islands"
output: html_notebook
---
```{r setup, include = FALSE, message=FALSE}
# load libraries
library(EML)
library(emld)
library(tidyverse)

# load data
source("https://raw.githubusercontent.com/pinskylab/OceanAdapt/master/EML_metadata/00-scripts/gen-cols-units.R")

sample_data <- read_csv("https://raw.githubusercontent.com/pinskylab/OceanAdapt/master/data_raw/ai1983_2000.csv", n_max = 6)

strata <- read_csv("https://raw.githubusercontent.com/pinskylab/OceanAdapt/master/data_raw/ai_strata.csv", n_max = 6)
```

## Source:
[NOAA Alaska Fisheries Science Center Groundfish Assessment Program surveys](https://www.afsc.noaa.gov/RACE/groundfish/survey_data/default.htm)

## Related papers:  
- [NOAA Technical Memorandum NMFS-AFSC-215 Data Report: 2010 Aleutian Islands bottom trawl survey](https://www.afsc.noaa.gov/Publications/AFSC-TM/NOAA-TM-AFSC-215.pdf)  

- [NOAA Protocols for Groundfish Bottom Trawl Surveys of the Nationâ€™s Fishery Resources March 16, 2003](https://www.afsc.noaa.gov/RACE/gearsupport/tmspo65.pdf)  
- [Species Codebook 2011](ai_species_codebook_2011.pdf)  
- [Species Identification Confidence in the Gulf of Alaska and Aleutian Islands Surveys (1980-2011)](https://www.afsc.noaa.gov/Publications/ProcRpt/PR2014-01.pdf)  
- [Groundfish Bottom Trawl Survey Protocols](https://www.fisheries.noaa.gov/resource/document/groundfish-bottom-trawl-survey-protocols)

## How we process the data:  
- The 2014-2018.csv file has a comment that contains a comma, which affects the parsing of the csv file.  We fix this by replacing all occurrences of "Stone et al., 2011" with "Stone et al. 2011".  This causes the columns to parse correctly.  
- Some of the files contain extra headers in the data rows, so we remove any data rows that contain the word "LATITUDE" in the LATITUDE column.  
- We create a haulid by combining a 3 digit leading zero vessel number with a 3 digit leading zero cruise number and a 3 digit leading zero haul number, separated by "-", for example: (vessel-cruise-haul) 354-067-001.  
- If wtcpue is recorded as "-9999", we change the value to NA.  
- We remove any SCIENTIFIC spp values that contain the word "egg" or where the only value in the SCIENTIFIC field is white space.  
- Any values SCIENTIFIC values that contain the word "Atheresthes" are changed to "Atheresthes sp." because more than one genus/spp combo was used to describe the same organism over time.  This also holds true for Lepidopsetta sp., Myoxocephalus sp. excluding scorpius, & Bathyraja sp. excluding panthera.  
- We correct the longitude for the Aleutians by subtracting 360 from any longitude value over 0.
- We group the data by haulid, stratum, stratumarea, year, lat, lon, depth,  and spp and then sum up all of the wtcpue values for each group and reassign that as the wtcpue.

## What the raw data includes:  
The current files of raw data for the Aleutian Islands are `r list.files(here::here("data_raw"), pattern = "ai")`.

### ai_strata.csv is constant through the years with the column definitions  
```{r include = FALSE}
st_attributes <- tibble(
  attributeName = dput(names(strata))) %>% 
  left_join(column_defs)
```
```{r echo=FALSE, message=TRUE, warning=TRUE}
knitr::kable(st_attributes) %>% 
  kableExtra::kable_styling(latex_options = "scale_down")
```

### The remaining files are trawl data files, data added annually, with the column definitions
```{r include = FALSE}
# create a table with each column from the dataset represented as a row.  There will be an error message about undefined units but they are defined later when the dataset is created.
# dput(names(sample_data))

attributes <- tribble(~attributeName, ~attributeDefinition, ~col_classes, ~unit, ~formatString,
                      
                      "LATITUDE", "The latitude (decimal degrees) at the start of the haul", "numeric", "degree", NA,
                      
                      "LONGITUDE", "The longitude (decimal degrees) at the start of the haul", "numeric", "degree", NA,
                      
                      "STATION", "Unique sequential order in which stations have been completed. Hangups and short tows each receive a non-repeated consecutive number.","character", "dimensionless", NA,
                      
                      "STRATUM", NA, "character", "dimensionless", NA,
                      "YEAR", "a 4 digit string containing the year of the survey", "character", "dimensionless", "YYYY",
                      "DATETIME", "This is the date and time at the beginning of the haul; This is the date and time at the beginning of the haul; For groundfish trawl data, this is the on-bottom time which is determined after we have looked at the bottom-contact sensor and net-mensuration plots. ", "character" , "dimensionless", NA,
                      "WTCPUE",  "Catch weight per area the net swept in KG/HA.", "numeric", "kilogramsPerHectare", NA,
                      "NUMCPUE", "Catch number per area the net swept in number/HA.", "numeric", "dimensionless", NA,
               "COMMON", "The common name of the marine organism associated with the SCIENTIFIC_NAME","character", "dimensionless", NA,
               "SCIENTIFIC", "The scientific name of the organism associated with the COMMON_NAME.", "character", "dimensionless", NA,
               "SID", "Domain: RACE Species Codebook; http://www.afsc.noaa.gov/RACE/groundfish/species_codebook.pdf", "numeric", "dimensionless", NA,
               "BOT_DEPTH", "Weighted average depth (m) and is calculated by adding GEAR_DEPTH to NET_HEIGHT. Prior to (year), before NET_HEIGHT was regularly measured, this value was obtained using either echosounder or bathythermograph.", "numeric", "meter", NA, 
               "BOT_TEMP", "Weighted average temperature (in tenths of a degree Celsius) measured at the maximum depth of the headrope of the trawl. Null values indicate temperature not recoreded.", "numeric", "celsius", NA,
               "SURF_TEMP", "Weighted average temperature (in tenths of a degree Celsius) measured at the sea surface of the trawl. Null values indicate temperature not recoreded.", "numeric", "celsius", NA,
               "CRUISE", "This is a six-digit number identifying the Cruise number. It is of the form: YYYY99 (where YYYY = year of the cruise; 99 = 2-digit number and is sequential; 01 denotes the first cruise that vessel made in this year, 02 is the second, etc.)", "character", "dimensionless", NA,
               "HAUL", "This number uniquely identifies a haul within a cruise. It is a sequential number, in chronological order of occurrence.", "numeric", "dimensionless", NA)
```
```{r echo=FALSE}
knitr::kable(select(attributes, -formatString)) %>% 
  kableExtra::kable_styling(latex_options = "scale_down")
```

```{r include = FALSE}
# define custom units
id <- c("kilograms per tow", "number per tow", "square kilometers")
dimension <- c("weight", "count", "area")
unitTypes <- data.frame(
  id = id, dimension = dimension, stringsAsFactors = FALSE
)
units <- data.frame(
  id = id, unitType = unitTypes, stringsAsFactors = FALSE
)

unitList <- set_unitList(units, unitTypes)

# define the rest of the data
# <title>
	# character vector title
	dataTitle <- "Aleutian Islands bottom trawl survey"

# <creator>
	# organization name
	afsc.name <- "National Oceanic and Atmospheric Administration (NOAA) Alaska Fisheries Science Center (AFSC) Resource Assessment and Conservation Engineering Division (RACE)"
	# create organization address
	afsc_address <- list( 
		deliveryPoint = "7600 Sand Point Way, N.E. bldg. 4",
		city = "Seattle",
		administrativeArea = "WA",
		postalCode = "98115",
		country = "USA"
	)
	
	publisher <- list(
	organizationName = afsc.name,
	address = afsc_address,
	onlineUrl = "http://www.afsc.noaa.gov/RACE/groundfish/survey_data/default.htm")

	R_person <- person(given = "Wayne", family = "Palsson", email = "Wayne.Palsson@noaa.gov", role = "cre")
	wayne <- as_emld(R_person)

	metadataProvider <- as_emld(person(given="Michelle", family = "Stuart",email = "michelle.stuart@rutgers.edu"))
	
others <- as.person("Bob Lauth [ctb] <Bob.Lauth@noaa.gov>")
associatedParty <- as_emld(others)
associatedParty[[1]]$organizationName <- afsc.name
	
# <pubDate>
pubDate <- "2012"

# <intellectualRights>
	# IR <- "this is just a long piece of text"

# <abstract>
abstract <- set_TextType(text = "The Resource Assessment and Conservation Engineering Division (RACE) of the Alaska Fisheries Science Center (AFSC) conducts bottom trawl surveys to monitor the condition of the demersal fish and crab stocks of Alaska. These data include catch per unit effort for each identified species at a standard set of stations. This is a subset of the main racebase datase. Excluded are non standard stations, earlier years using different gear, and other types of data collected other than species id, species weight, water temperature and depth.")

# This isn't working right now
# # <methods>
# 	methods <- 	list(dataSource="http://www.afsc.noaa.gov/RACE/groundfish/survey_data/default.htm",
# 				description="http://www.afsc.noaa.gov/RACE/groundfish/survey_data/metadata_template.php?fname=RACEweb.xml"
# 			) 
# 	set_methods(methods)

	

# ======================
# = Create EML Objects =
# ======================

ai.data <- set_physical("https://raw.githubusercontent.com/pinskylab/OceanAdapt/master/data_raw/ai1983_2000.csv")
# Create "dataTable": the physical data set with associated column definitions and units
ai.dataTable <- list(
		physical=ai.data,
		entityName="AI",
		entityDescription = "Bottom Trawl Data in the Aleutian Islands",
		attributeList = attributeList
)


eml <- list(
           packageId = uuid::UUIDgenerate(),  
           system = "uuid",
           dataset = list(
               title = dataTitle,
               creator = wayne,
               pubDate = pubDate,
               # abstract = abstract,
               contact = wayne,
               additionalMetadata = list(metadata = list(unitList = unitList)),
               dataTable = ai.dataTable
               ))


# validate
eml_validate(eml)

# Write EML data file
write_eml(eml, file=here::here("metadata","ai.xml"))
```

The Ecological Metadata Language file can be accessed [here](https://github.com/pinskylab/OceanAdapt/blob/master/metaData/ai.xml)
